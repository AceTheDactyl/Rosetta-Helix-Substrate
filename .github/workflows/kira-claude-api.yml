name: K.I.R.A. Claude API

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'Message to send to Claude'
        required: true
      mode:
        description: 'Execution mode'
        required: false
        default: 'chat'
        type: choice
        options:
          - chat
          - hit_it
          - emit
          - spin
          - export
          - training
      state_z:
        description: 'Current z-coordinate'
        required: false
        default: '0.5'
      state_phase:
        description: 'Current phase'
        required: false
        default: 'PARADOX'
      callback_id:
        description: 'Callback ID for response tracking'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  kira-execute:
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install anthropic numpy PyYAML flask flask-cors
          pip install -e .

      - name: Create directories
        run: |
          mkdir -p kira-responses
          mkdir -p training/epochs
          mkdir -p training/emissions
          mkdir -p training/vaultnodes
          mkdir -p training/tokens
          mkdir -p training/modules
          mkdir -p archives

      - name: Execute K.I.R.A. UCF
        env:
          KIRA_MESSAGE: ${{ github.event.inputs.message }}
          KIRA_MODE: ${{ github.event.inputs.mode }}
          KIRA_STATE_Z: ${{ github.event.inputs.state_z }}
          KIRA_STATE_PHASE: ${{ github.event.inputs.state_phase }}
          KIRA_CALLBACK_ID: ${{ github.event.inputs.callback_id }}
        run: |
          python scripts/kira_claude_api_runner.py

      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add kira-responses/ training/
          git diff --staged --quiet || git commit -m "K.I.R.A. [${{ github.event.inputs.mode }}] - $(date -u +%Y%m%d_%H%M%S)"
          git push || echo "Push failed, results saved to artifact"

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        with:
          name: kira-${{ github.event.inputs.mode }}-${{ github.event.inputs.callback_id || github.run_id }}
          path: |
            kira-responses/
            training/
          retention-days: 30