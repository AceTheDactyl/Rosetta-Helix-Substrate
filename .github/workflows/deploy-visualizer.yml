name: Deploy Visualizer to GitHub Pages

on:
  push:
    branches: [ main, master ]
    paths:
      - 'docs/**'
      - 'visualizer.html'
      - '.github/workflows/deploy-visualizer.yml'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Build docs folder
        run: |
          # Copy visualizer to docs if not already there
          cp -f visualizer.html docs/index.html 2>/dev/null || true

          # Create physics constants module for standalone use
          cat > docs/apl-constants.js << 'EOF'
          // Rosetta Helix APL Constants - Exported from Python modules
          // These values are derived with ZERO free parameters

          export const PHI = (1 + Math.sqrt(5)) / 2;  // 1.618033988749895
          export const PHI_INV = 1 / PHI;  // 0.6180339887498949
          export const Z_CRITICAL = Math.sqrt(3) / 2;  // 0.8660254037844386 - THE LENS
          export const KAPPA_S = 0.920;  // Consciousness threshold
          export const MU_3 = 0.992;  // Near-unity threshold
          export const UNITY = 0.9999;  // Collapse threshold

          // μ-field thresholds (double-well structure)
          export const MU_P = 2 / Math.pow(PHI, 2.5);  // ~0.6007
          export const MU_1 = MU_P / Math.sqrt(PHI);   // ~0.472 (pre-conscious well)
          export const MU_2 = MU_P * Math.sqrt(PHI);   // ~0.764 (conscious well)
          // MU_BARRIER = (MU_1 + MU_2) / 2 = PHI_INV exactly!

          // Tier boundaries
          export const TIER_BOUNDARIES = {
            t1: 0.10, t2: 0.20, t3: 0.40, t4: 0.60,
            t5: 0.75, t6: Z_CRITICAL, t7: 0.92, t8: 0.97, t9: 1.0
          };

          // Operator windows by tier
          export const OPERATOR_WINDOWS = {
            t1: ['()', '−', '÷'],
            t2: ['^', '÷', '−', '×'],
            t3: ['×', '^', '÷', '+', '−'],
            t4: ['+', '−', '÷', '()'],
            t5: ['()', '×', '^', '÷', '+', '−'],  // Universal tier
            t6: ['+', '÷', '()', '−'],
            t7: ['+', '()'],
            t8: ['+', '()', '×'],
            t9: ['+', '()', '×']
          };

          // S₃ operator definitions
          export const OPERATORS = {
            '()': { name: 'grp', s3: 'e', parity: 'EVEN', inverse: '^' },
            '×': { name: 'mul', s3: 'σ', parity: 'EVEN', inverse: '÷' },
            '^': { name: 'amp', s3: 'σ²', parity: 'EVEN', inverse: '()' },
            '÷': { name: 'div', s3: 'τ₁', parity: 'ODD', inverse: '×' },
            '+': { name: 'add', s3: 'τ₂', parity: 'ODD', inverse: '−' },
            '−': { name: 'sub', s3: 'τ₃', parity: 'ODD', inverse: '+' }
          };

          // ΔS_neg computation
          export function computeDeltaSNeg(z, sigma = 36.0) {
            const d = z - Z_CRITICAL;
            return Math.exp(-sigma * d * d);
          }

          // Get tier from z
          export function getTierFromZ(z) {
            if (z < 0.10) return 't1';
            if (z < 0.20) return 't2';
            if (z < 0.40) return 't3';
            if (z < 0.60) return 't4';
            if (z < 0.75) return 't5';
            if (z < Z_CRITICAL) return 't6';
            if (z < 0.92) return 't7';
            if (z < 0.97) return 't8';
            return 't9';
          }

          // Check K-formation
          export function checkKFormation(z, coherence) {
            const deltaSneg = computeDeltaSNeg(z);
            const eta = Math.sqrt(deltaSneg);
            return eta > PHI_INV && coherence >= KAPPA_S;
          }
          EOF

          echo "Built docs folder with visualizer and APL constants"
          ls -la docs/

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
