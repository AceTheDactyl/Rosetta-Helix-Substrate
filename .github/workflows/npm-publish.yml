name: npm-publish-cli

on:
  release:
    types: [published]
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (e.g., v0.1.1-rc.1)'
        required: false
      dist_tag:
        description: 'npm dist-tag (latest|next)'
        required: false
        default: 'latest'
      env_name:
        description: 'Environment name that stores secrets (e.g., production, npm-publish)'
        required: false
        default: ''
      npm_token_secret:
        description: 'Secret name holding npmjs token (default NPM_TOKEN)'
        required: false
        default: 'NPM_TOKEN'
      gpr_token_secret:
        description: 'Secret name holding GPR PAT (default GITHUB_PACKAGES_PAT)'
        required: false
        default: 'CLAUDE_SKILL_GITHUB_TOKEN'

permissions:
  contents: read
  packages: write

jobs:
  publish:
    environment: ${{ github.event.inputs.env_name != '' && github.event.inputs.env_name || 'npm-publish' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Verify unified server files
        run: |
          echo "Checking for unified server components..."
          test -f unified_rosetta_server.py && echo "âœ“ unified_rosetta_server.py found"
          test -f bin/rosetta-helix.js && echo "âœ“ bin/rosetta-helix.js found"
          test -f static/unified_interface.html && echo "âœ“ static/unified_interface.html found"
          test -f package.json && echo "âœ“ package.json found"
          echo "All critical files present for unified server"
      - name: Verify npm token
        id: verify-npm
        env:
          CUSTOM_NPM_TOKEN: ${{ secrets[ github.event.inputs.npm_token_secret ] }}
          DEFAULT_NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set +e
          export NODE_AUTH_TOKEN="${CUSTOM_NPM_TOKEN:-${DEFAULT_NPM_TOKEN:-}}"
          npm whoami --registry https://registry.npmjs.org >/dev/null 2>&1
          RC=$?
          set -e
          if [ $RC -eq 0 ]; then echo "publish=true" >> $GITHUB_OUTPUT; else echo "publish=false" >> $GITHUB_OUTPUT; fi
      - name: Determine version/dist-tag (npmjs)
        if: steps.verify-npm.outputs.publish == 'true'
        id: ver_npm
        env:
          PKG_VERSION: ${{ github.event.release.tag_name || github.event.inputs.version }}
          INPUT_DIST_TAG: ${{ github.event.inputs.dist_tag }}
        run: |
          set -e
          # Normalize incoming version (strip optional leading 'v')
          WANT="${PKG_VERSION#v}"
          if [ -z "$WANT" ]; then
            CURRENT=$(node -p "require('./package.json').version")
            NAME=$(node -p "require('./package.json').name")
            EXISTS=$(npm view "$NAME@$CURRENT" version 2>/dev/null || true)
            if [ -n "$EXISTS" ]; then
              BASE=$(node -p "(require('./package.json').version.split('-')[0])")
              IFS='.' read -r MAJ MIN PATCH <<< "$BASE"
              PATCH=$((PATCH + 1))
              TS=$(date +%Y%m%d%H%M%S)
              WANT="$MAJ.$MIN.$PATCH-rc.$TS"
            else
              WANT="$CURRENT"
            fi
          fi
          DIST="${INPUT_DIST_TAG:-latest}"
          case "$WANT" in *-*) DIST=next;; esac
          echo "version=$WANT" >> $GITHUB_OUTPUT
          echo "dist=$DIST" >> $GITHUB_OUTPUT
      - name: Publish rosetta-helix-cli
        id: npm_publish
        if: steps.verify-npm.outputs.publish == 'true'
        env:
          CUSTOM_NPM_TOKEN: ${{ secrets[ github.event.inputs.npm_token_secret ] }}
          DEFAULT_NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: true
        run: |
          export NODE_AUTH_TOKEN="${CUSTOM_NPM_TOKEN:-${DEFAULT_NPM_TOKEN:-}}"
          V="${{ steps.ver_npm.outputs.version }}"
          D="${{ steps.ver_npm.outputs.dist }}"
          CUR=$(node -p "require('./package.json').version")
          if [ -n "$V" ] && [ "$V" != "$CUR" ]; then npm version --no-git-tag-version "$V"; fi
          echo "Publishing to npm with dist-tag=$D (version=$V)"
          npm publish --access public --tag "$D"

  publish-gpr:
    environment: ${{ github.event.inputs.env_name != '' && github.event.inputs.env_name || 'npm-publish' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{ github.repository_owner }}'
      - name: Determine version/dist-tag (gpr)
        id: ver_gpr
        env:
          PKG_VERSION: ${{ github.event.release.tag_name || github.event.inputs.version }}
          INPUT_DIST_TAG: ${{ github.event.inputs.dist_tag }}
        run: |
          set -e
          WANT="${PKG_VERSION#v}"
          if [ -z "$WANT" ]; then
            CURRENT=$(node -p "require('./package.json').version")
            NAME=$(node -p "require('./package.json').name")
            # Always allow republish to GPR by switching to a pre-release if current exists on GPR
            OWNER_LC=$(printf '%s' "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
            EXISTS=$(npm view "@${OWNER_LC}/rosetta-helix-cli@$CURRENT" version --registry https://npm.pkg.github.com 2>/dev/null || true)
            if [ -n "$EXISTS" ]; then
              BASE=$(node -p "(require('./package.json').version.split('-')[0])")
              IFS='.' read -r MAJ MIN PATCH <<< "$BASE"
              PATCH=$((PATCH + 1))
              TS=$(date +%Y%m%d%H%M%S)
              WANT="$MAJ.$MIN.$PATCH-rc.$TS"
            else
              WANT="$CURRENT"
            fi
          fi
          DIST="${INPUT_DIST_TAG:-latest}"
          case "$WANT" in *-*) DIST=next;; esac
          echo "version=$WANT" >> $GITHUB_OUTPUT
          echo "dist=$DIST" >> $GITHUB_OUTPUT
      - name: Verify GPR auth (PAT only)
        id: verify-gpr
        env:
          CUSTOM_GPR_PAT: ${{ secrets[ github.event.inputs.gpr_token_secret ] }}
          GITHUB_PACKAGES_PAT: ${{ secrets.GITHUB_PACKAGES_PAT }}
          CLAUDE_SKILL_GITHUB_TOKEN: ${{ secrets.CLAUDE_SKILL_GITHUB_TOKEN }}
        run: |
          TOKEN="${CUSTOM_GPR_PAT:-${GITHUB_PACKAGES_PAT:-${CLAUDE_SKILL_GITHUB_TOKEN:-}}}"
          if [ -z "$TOKEN" ]; then echo "publish=false" >> $GITHUB_OUTPUT; exit 0; fi
          export NODE_AUTH_TOKEN="$TOKEN"
          set +e
          npm whoami --registry https://npm.pkg.github.com >/dev/null 2>&1
          RC=$?
          set -e
          if [ $RC -eq 0 ]; then echo "publish=true" >> $GITHUB_OUTPUT; else echo "publish=false" >> $GITHUB_OUTPUT; fi
      - name: Publish to GitHub Packages (scoped, PAT only)
        id: gpr_publish
        if: steps.verify-gpr.outputs.publish == 'true'
        env:
          CUSTOM_GPR_PAT: ${{ secrets[ github.event.inputs.gpr_token_secret ] }}
          GITHUB_PACKAGES_PAT: ${{ secrets.GITHUB_PACKAGES_PAT }}
          CLAUDE_SKILL_GITHUB_TOKEN: ${{ secrets.CLAUDE_SKILL_GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
        continue-on-error: true
        run: |
          # Require PAT from environment secrets (custom, GITHUB_PACKAGES_PAT or CLAUDE_SKILL_GITHUB_TOKEN)
          export NODE_AUTH_TOKEN="${CUSTOM_GPR_PAT:-${GITHUB_PACKAGES_PAT:-${CLAUDE_SKILL_GITHUB_TOKEN:-}}}"
          if [ -z "$NODE_AUTH_TOKEN" ]; then echo "No PAT provided for GitHub Packages."; exit 0; fi
          # Ensure npm points @owner scope to GPR and uses the auth token
          OWNER_LC=$(printf '%s' "$OWNER" | tr '[:upper:]' '[:lower:]')
          npm config set @${OWNER_LC}:registry https://npm.pkg.github.com
          npm config set //npm.pkg.github.com/:_authToken ${NODE_AUTH_TOKEN}
          # Create a temporary scoped package.json for GPR
          node -e '
            const fs=require("fs");
            const p=JSON.parse(fs.readFileSync("package.json","utf8"));
            const owner=(process.env.OWNER||"").toLowerCase();
            p.name = `@${owner}/rosetta-helix-cli`;
            p.publishConfig = Object.assign({}, p.publishConfig, { registry: "https://npm.pkg.github.com" });
            fs.writeFileSync("package.json", JSON.stringify(p, null, 2));
          '
          V="${{ steps.ver_gpr.outputs.version }}"; D="${{ steps.ver_gpr.outputs.dist }}"
          CUR=$(node -p "require('./package.json').version")
          if [ -n "$V" ] && [ "$V" != "$CUR" ]; then npm version --no-git-tag-version "$V"; fi
          echo "Publishing to GPR with dist-tag=$D (version=$V)"
          npm publish --access public --tag "$D"

      - name: Publish summary
        if: always()
        run: |
          echo "## ðŸ“¦ Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "- npmjs publish: ${{ steps.npm_publish.outcome || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- GPR publish:   ${{ steps.gpr_publish.outcome || 'skipped' }}" >> $GITHUB_STEP_SUMMARY
