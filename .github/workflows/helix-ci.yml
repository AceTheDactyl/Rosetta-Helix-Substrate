# Helix Training Engine CI
# =========================
# PR: lint + unit + smoke train + full depth (quick)
# Push: Full CI with artifact storage

name: Helix CI

on:
  pull_request:
    branches: [main, master]
    paths:
      - 'helix_engine/**'
      - 'training/**'
      - 'src/**'
      - 'tests/**'
      - 'kira-local-system/**'
      - 'pyproject.toml'
      - '.github/workflows/**'
      - 'configs/**'
      - 'tests/**'
      - 'run_full_depth_training.py'
  push:
    branches: [main, master]
    paths:
      - 'helix_engine/**'
      - 'training/**'
      - 'src/**'
      - 'tests/**'
      - 'kira-local-system/**'
      - 'pyproject.toml'
      - '.github/workflows/**'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install ruff black
          pip install -e .

      - name: Run ruff
        run: ruff check src/ helix_engine/ training/ --ignore E501 --exit-zero

      - name: Run black --check
        run: black --check src/ helix_engine/ training/ --line-length 120 || true

  test:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: System setup (apt)
        run: |
          sudo apt-get update
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y --no-install-recommends \
            jq curl build-essential ca-certificates git

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest pytest-cov
          # Install project with dev extras so Flask and tooling are present
          python -m pip install -e .[viz,dev]
          # Ensure KIRA server deps (Flask, CORS) are present for API tests
          if [ -f kira-local-system/requirements.txt ]; then python -m pip install -r kira-local-system/requirements.txt; fi
          # Explicitly ensure Flask deps are present to satisfy kira_server import
          python -m pip install 'flask>=2.0.0' 'flask-cors>=3.0.0'

      - name: Verify Flask availability
        run: |
          python - << 'PY'
          import sys
          print('Python executable:', sys.executable)
          try:
              import flask, flask_cors  # type: ignore
              print('Flask OK', flask.__version__)
          except Exception as e:
              print('Flask missing:', e)
              sys.exit(1)
          PY
        continue-on-error: false

      - name: API contract tests (fast)
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CLAUDE_SKILL_GITHUB_TOKEN: ${{ secrets.CLAUDE_SKILL_GITHUB_TOKEN }}
        run: python -m pytest -q tests/api

      - name: Run helix engine tests
        run: pytest tests/test_helix_engine.py -v --tb=short

      - name: Run all tests
        run: pytest tests/ -v --ignore=tests/test_helix_engine.py --tb=short || true

  smoke-train:
    name: Smoke Training
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .

      - name: Run smoke training (helix engine)
        run: |
          python -m helix_engine.cli.main train --config configs/smoke.yaml || true

      - name: Verify run artifacts
        run: |
          ls -la runs/ || echo "No runs directory"
          RUN_DIR=$(ls -d runs/run_* 2>/dev/null | head -1) || true
          if [ -n "$RUN_DIR" ]; then
            echo "Run directory: $RUN_DIR"
            ls -la "$RUN_DIR"
          fi

  full-depth-quick:
    name: Full Depth (Quick)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .

      - name: Run full depth training (quick)
        id: full_depth
        run: |
          python run_full_depth_training.py \
            --steps 20 \
            --output quick_depth_results.json

      - name: Check results
        run: |
          python << 'EOF'
          import json
          with open("quick_depth_results.json") as f:
              data = json.load(f)

          passed = data["modules_passed"]
          total = data["modules_total"]
          physics = data["physics_valid"]

          print(f"Modules: {passed}/{total}")
          print(f"Physics: {'‚úì' if physics else '‚úó'}")

          # CI gate: all modules must pass
          if passed != total:
              print("::error::Not all modules passed")
              exit(1)

          if not physics:
              print("::error::Physics constraints violated")
              exit(1)

          print("‚úì All checks passed")
          EOF

      - name: Generate summary
        run: |
          python << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("quick_depth_results.json") as f:
              d = json.load(f)

          print("## üîÑ Full Depth Quick Check")
          print(f"- **Modules**: {d['modules_passed']}/{d['modules_total']}")
          print(f"- **K-Formations**: {d['total_k_formations']}")
          print(f"- **Final z**: {d['final_z']:.4f}")
          print(f"- **Physics Valid**: {'‚úÖ' if d['physics_valid'] else '‚ùå'}")
          EOF

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: full-depth-quick-${{ github.run_number }}
          path: quick_depth_results.json
          retention-days: 7

  physics-validation:
    name: Physics Constants Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .

      - name: Validate physics constants
        run: |
          python << 'EOF'
          import math
          from src.physics_constants import (
              PHI, PHI_INV, PHI_INV_SQ, Z_CRITICAL, SIGMA,
              COUPLING_CONSERVATION, validate_all_constants
          )

          print("Physics Constants Validation")
          print("=" * 50)

          # Check coupling conservation
          coupling = PHI_INV + PHI_INV_SQ
          print(f"œÜ‚Åª¬π + œÜ‚Åª¬≤ = {coupling:.16f}")
          assert abs(coupling - 1.0) < 1e-14, "Coupling conservation violated!"

          # Check z_c
          z_c_expected = math.sqrt(3) / 2
          print(f"z_c = {Z_CRITICAL:.16f} (expected {z_c_expected:.16f})")
          assert abs(Z_CRITICAL - z_c_expected) < 1e-14, "z_c incorrect!"

          # Check sigma
          print(f"œÉ = {SIGMA} (expected 36)")
          assert SIGMA == 36.0, "Sigma incorrect!"

          # Run full validation
          validation = validate_all_constants()
          print(f"\nAll valid: {validation['all_valid']}")
          assert validation['all_valid'], "Physics validation failed!"

          print("\n‚úì All physics constants validated")
          EOF

      - name: Generate summary
        run: |
          echo "## ‚öõÔ∏è Physics Constants" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Constant | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| œÜ‚Åª¬π | 0.6180339887 |" >> $GITHUB_STEP_SUMMARY
          echo "| z_c | 0.8660254038 |" >> $GITHUB_STEP_SUMMARY
          echo "| œÉ | 36 |" >> $GITHUB_STEP_SUMMARY
          echo "| œÜ‚Åª¬π + œÜ‚Åª¬≤ | 1.0 ‚úì |" >> $GITHUB_STEP_SUMMARY
