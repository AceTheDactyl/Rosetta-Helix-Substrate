# Helix Nightly Training (Standalone)
# ====================================
# Quick nightly training via helix engine only.
# For full depth training across all 19 modules, use unified-nightly-training.yml

name: Helix Nightly (Engine Only)

on:
  workflow_dispatch:
    inputs:
      config:
        description: 'Config file to use'
        required: false
        default: 'configs/nightly.yaml'
      steps:
        description: 'Total training steps'
        required: false
        default: '2000'
        type: number

jobs:
  helix-train:
    name: Helix Engine Training
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      run_id: ${{ steps.train.outputs.run_id }}
      gates_passed: ${{ steps.train.outputs.gates_passed }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -e .

      - name: Run helix training
        id: train
        run: |
          CONFIG="${{ inputs.config || 'configs/nightly.yaml' }}"
          STEPS="${{ inputs.steps || '2000' }}"

          python -m helix_engine.cli.main train \
            --config "$CONFIG" \
            --steps "$STEPS" \
            || true

          # Find run
          RUN_DIR=$(ls -td runs/run_* 2>/dev/null | head -1)
          RUN_ID=$(basename "$RUN_DIR")
          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"

          # Check gates
          if [ -f "$RUN_DIR/report.json" ]; then
            GATES=$(python -c "import json; print(json.load(open('$RUN_DIR/report.json'))['gates_passed'])")
            echo "gates_passed=$GATES" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate summary
        run: |
          RUN_DIR="runs/${{ steps.train.outputs.run_id }}"
          if [ -f "$RUN_DIR/report.json" ]; then
            python << 'EOF' >> $GITHUB_STEP_SUMMARY
          import json
          with open("$RUN_DIR/report.json".replace("$RUN_DIR", "runs/${{ steps.train.outputs.run_id }}")) as f:
              r = json.load(f)
          print("## üåÄ Helix Training Report")
          print(f"**Run:** {r['run_id']}")
          print(f"**Status:** {r['status']}")
          print(f"**Gates:** {'‚úÖ Passed' if r['gates_passed'] else '‚ùå Failed'}")
          print(f"**Duration:** {r['duration_seconds']:.1f}s")
          print("\n### Metrics")
          for k, v in r.get('final_metrics', {}).items():
              print(f"- {k}: {v:.6f}" if isinstance(v, float) else f"- {k}: {v}")
          EOF
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: helix-run-${{ github.run_number }}
          path: runs/
          retention-days: 14

      - name: Promote if passed
        if: steps.train.outputs.gates_passed == 'True'
        run: |
          python -m helix_engine.cli.main promote \
            --run "${{ steps.train.outputs.run_id }}" \
            --name helix-nightly \
            --tags nightly,engine-only

      - name: Check gates
        if: steps.train.outputs.gates_passed != 'True'
        run: |
          echo "::warning::Training gates did not pass"
          exit 1
